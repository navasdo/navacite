{% extends "base.html" %}

{% block title %}Literacy Launchpad{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .modal { transition: opacity 300ms ease-in-out; }
        .modal-content { transition: opacity 300ms ease-in-out, transform 300ms ease-in-out; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal:not(.hidden) { opacity: 1; }
        .modal.hidden .modal-content { opacity: 0; transform: scale(0.95); }
        .modal:not(.hidden) .modal-content { opacity: 1; transform: scale(1); }
        .modal-scroll::-webkit-scrollbar { width: 8px; }
        .modal-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .modal-scroll::-webkit-scrollbar-thumb { background-color: #4c1d95; border-radius: 10px; border: 2px solid #1e293b; }
        
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }

        @keyframes pulse-heart { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .animate-pulse-heart { animation: pulse-heart 0.5s ease-in-out; }

        @keyframes fade-out-up { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .notification-item {
            animation: fade-in-up 0.5s ease-out forwards, fade-out-up 0.5s ease-in forwards 2s;
        }
        .map-container {
            aspect-ratio: 9 / 16;
            overflow-y: scroll;
            scroll-behavior: smooth;
        }
        .map-container::-webkit-scrollbar { display: none; }
    </style>
{% endblock %}

{% block content %}
    <div id="root"></div>
{% endblock %}

{% block scripts %}
{% raw %}
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const { createPortal } = ReactDOM;

        // --- Game Data & Assets ---
        const correctSound = new Audio("https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/language-tools/literacy-launchpad/static/audio/correct.wav");
        const incorrectSound = new Audio("https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/language-tools/literacy-launchpad/static/audio/damage.mp3");
        const streakSound = new Audio("https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/language-tools/literacy-launchpad/static/audio/streak.mp3");
        const multiplierSound = new Audio("https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/language-tools/literacy-launchpad/static/audio/multiplier.mp3");
        const heartSound = new Audio("https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/language-tools/literacy-launchpad/static/audio/healing.mp3");

        const passages = {
            '2-3': {
                'Jungle of Syntax': "A little monkey likes to [play|plays|playing]. He swings from a [branch|leaf|root] all day long. His mom tells him to be [careful|carefully|caring] so he does not fall down. The monkey sees a bright yellow [banana|rock|flower] hanging from a vine. He gets very [excited|exciting|excite] and chatters happily.",
            },
            '4-5': {
                'Vocabulary Volcano': "The ancient volcano was [dormant|sleeping|sleep], meaning it had not erupted for a long time. The villagers felt safe living nearby. They cultivated the [fertile|good|fast] soil on its slopes, growing delicious fruits and vegetables. One day, a scientist came to [inspect|look|looking] the volcano. She said there was no immediate [danger|bad|dangerous], but it was wise to be prepared.",
            },
            '6-8': {
                'Caverns of Cohesion': "Space exploration presents immense challenges; [furthermore|however|because], it offers incredible rewards. The journey to Mars, for example, will require unprecedented technological [innovation|idea|invent]. Scientists must develop systems for life support, radiation shielding, and sustainable energy. [Despite|Although|Therefore] these obstacles, the quest to explore the red planet continues, driven by human curiosity and the search for knowledge.",
            }
        };
        
        const characterClasses = {
            adventurer: { name: 'Adventurer', bonus: '+1 starting heart', penalty: 'Slightly lower score multiplier', heartMod: 1, streakMod: 0, scoreMod: 0.9, variants: [{gender: 'Female', image100: 'adventurer-100_female_presenting.png', image50: 'adventurer-50-female_presenting.png'}, {gender: 'Male', image100: 'adventurer-100_male_presenting.png', image50: 'adventurer-50-male_presenting.png'}] },
            alchemist: { name: 'Alchemist', bonus: 'Heart rewards restore +2', penalty: 'Score rewards are smaller', heartMod: 0, streakMod: 0, scoreMod: 0.8, variants: [{gender: 'Neutral', image100: 'alchemist-100.png', image50: 'alchemist-50.png'}] },
            archer: { name: 'Archer', bonus: 'Higher streak bonus', penalty: 'Streaks require +1 correct answer', heartMod: 0, streakMod: 1, scoreMod: 1.2, variants: [{gender: 'Female', image100: 'archer-100-female_presenting.png', image50: 'archer-50-female_presenting.png'}, {gender: 'Male', image100: 'archer-100-male_presenting.png', image50: 'archer-50-male_presenting.png'}] },
            assassin: { name: 'Assassin', bonus: 'Massive score multiplier', penalty: 'Start with -3 hearts', heartMod: -3, streakMod: 0, scoreMod: 1.5, variants: [{gender: 'Female', image100: 'assassin-100-female_presenting.png', image50: 'assassin-50-female_presenting.png'}, {gender: 'Male', image100: 'assassin-100-male_presenting.png', image50: 'assassin-50-male_presenting.png'}] },
            bandit: { name: 'Bandit', bonus: 'More points from choices', penalty: 'No streak rewards', heartMod: 0, streakMod: 99, scoreMod: 1.3, variants: [{gender: 'Neutral', image100: 'bandit-100.png', image50: 'bandit-50.png'}] },
            barbarian: { name: 'Barbarian', bonus: 'Start with +3 hearts', penalty: 'Lower overall score', heartMod: 3, streakMod: 0, scoreMod: 0.7, variants: [{gender: 'Neutral', image100: 'barbarian-100.png', image50: 'barbarian-50.png'}] },
            beast_master: { name: 'Beast Master', bonus: 'First incorrect answer is free', penalty: 'Reduced streak bonus', heartMod: 0, streakMod: 0, scoreMod: 0.9, freebie: true, variants: [{gender: 'Neutral', image100: 'beast_master-100.png', image50: 'beast_master-50.png'}] },
            'dragon-knight': { name: 'Dragon Knight', bonus: 'Immune to first 2 mistakes', penalty: 'No score multiplier reward', heartMod: 0, streakMod: 0, scoreMod: 1, immune: 2, variants: [{gender: 'Neutral', image100: 'dragon-knight-100.png', image50: 'dragon_knight-50.png'}] },
            knight: { name: 'Knight', bonus: 'Balanced stats', penalty: 'None', heartMod: 0, streakMod: 0, scoreMod: 1, variants: [{gender: 'Male', image100: 'knight-100-male_presenting.png', image50: 'knight-50-male_presenting.png'}] },
            'martial-artist': { name: 'Martial Artist', bonus: 'Streaks activate faster', penalty: 'No heart reward option', heartMod: 0, streakMod: -1, scoreMod: 1.1, variants: [{gender: 'Female', image100: 'martial-artist-100-female_presenting.png', image50: 'martial-artist-50-female_presenting.png'}, {gender: 'Male', image100: 'martial-artist-100-male_presenting.png', image50: 'martial-artist-50-male_presenting.png'}] },
            samurai: { name: 'Samurai', bonus: 'Perfect answers grant huge bonus', penalty: 'Any mistake resets streak', heartMod: 0, streakMod: 0, scoreMod: 1.2, perfect: true, variants: [{gender: 'Neutral', image100: 'samurai-100.png', image50: 'samurai-50.png'}] },
            wizard: { name: 'Wizard', bonus: 'Streak score rewards are massively increased', penalty: 'Fewer starting hearts', heartMod: -2, streakMod: 0, scoreMod: 1, streakBonusMultiplier: 2.5, variants: [{gender: 'Female', image100: 'wizard-100-female_presenting.png', image50: 'wizard-50-female_presenting.png'}, {gender: 'Male', image100: 'wizard-100-male_presenting.png', image50: 'wizard-50-male_presenting.png'}] },
        };
        const classImageBaseUrl = "https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/language-tools/literacy-launchpad/static/images/character-avatars/";

        // --- Helper & Utility Components ---
        const IconInfo = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>);
        const IconHeart = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className={`text-red-500 ${className}`}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>;
        const IconTrophy = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const IconClock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconCheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        
        const BaseModal = ({ show, onClose, children, maxWidth = 'max-w-2xl' }) => {
            if (!show) return null;
            return createPortal(
                <div className={`modal fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 p-4`} onClick={onClose}>
                    <div className={`modal-content bg-slate-800 border border-violet-700/50 rounded-2xl shadow-2xl w-full ${maxWidth} max-h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
                        <div className="overflow-y-auto modal-scroll">{children}</div>
                    </div>
                </div>,
                document.body
            );
        };
        
        const PrivacyModal = ({ show, onClose }) => (
            <BaseModal show={show} onClose={onClose}>
                 <div className="p-6 sm:p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold text-slate-100">Student Data Privacy</h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div className="space-y-4 text-slate-300 text-left text-sm">
                        <p>This application is designed to support language assessment activities without collecting or maintaining student data.</p>
                        <p><strong className="text-violet-400 block mb-1">Student Information Use:</strong> Student names may be entered by the examiner for the sole purpose of personalizing a printable PDF report. This information is not transmitted, stored, or retained by the application or its hosting service.</p>
                        <p><strong className="text-violet-400 block mb-1">Data Retention:</strong> Once the examiner completes an assessment, the entered name is cleared from the page. No student information is written to logs, databases, or external servers.</p>
                    </div>
                 </div>
            </BaseModal>
        );
        
        // --- Main App Component ---
        function App() {
            const [screen, setScreen] = useState('setup');
            const [gameSettings, setGameSettings] = useState(null);
            const [gameResults, setGameResults] = useState(null);
            const [leaderboardData, setLeaderboardData] = useState([]);

            const fetchLeaderboard = useCallback(() => {
                // In a real environment, this fetch would work. For the preview, we'll mock it.
                // fetch('/api/literacy-launchpad/leaderboard')
                //     .then(res => res.json())
                //     .then(data => setLeaderboardData(data))
                //     .catch(err => console.error("Failed to fetch leaderboard:", err));
                console.log("Fetching leaderboard (mocked for preview)...");
            }, []);

            useEffect(() => {
                fetchLeaderboard();
            }, [fetchLeaderboard]);

            const handleStartGame = (settings) => {
                setGameSettings(settings);
                setScreen('game');
            };
            
            const handleEndGame = (results) => {
                setGameResults(results);
                setScreen('results');
            };

            const handleRestart = () => {
                setGameSettings(null);
                setGameResults(null);
                setScreen('setup');
            };
            
            const renderScreen = () => {
                switch(screen) {
                    case 'game':
                        return <GameScreen settings={gameSettings} onEndGame={handleEndGame} />;
                    case 'results':
                        return <ResultsScreen results={gameResults} onRestart={handleRestart} leaderboard={leaderboardData} onUpdateLeaderboard={fetchLeaderboard} />;
                    case 'setup':
                    default:
                        return <SetupScreen onStartGame={handleStartGame} leaderboard={leaderboardData} />;
                }
            };

            return (
                <div className="w-full max-w-7xl mx-auto py-8">
                     <header className="text-center mb-12">
                        <img src="https://raw.githubusercontent.com/navasdo/navacite/main/templates/static/navacite-images/literacy-launchpad.png" alt="Literacy Launchpad Logo" className="w-48 mx-auto mb-4" style={{filter: 'drop-shadow(0 0 15px rgba(167, 139, 250, 0.4))'}} />
                        <h1 className="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-500">
                            Literacy Launchpad
                        </h1>
                        <p className="text-md md:text-lg text-slate-400 italic max-w-4xl mx-auto mt-2">
                            An engaging reading adventure that analyzes sentence-level comprehension to generate data-driven instructional hypotheses and connect you with evidence-based interventions. Choose your hero, embark on an adventure, and conquer reading challenges in a gamified quest for comprehension.
                        </p>
                    </header>
                    <main className="bg-slate-900/40 p-6 sm:p-8 rounded-2xl shadow-lg border border-violet-900/80">
                        {renderScreen()}
                    </main>
                </div>
            );
        }
        
        // --- Setup Screen Component ---
        function SetupScreen({ onStartGame, leaderboard }) {
            const [studentName, setStudentName] = useState('');
            const [level, setLevel] = useState('2-3');
            const [map, setMap] = useState('Jungle of Syntax');
            const [isPractice, setIsPractice] = useState(false);
            const [showPrivacyModal, setShowPrivacyModal] = useState(false);
            const [selectedClass, setSelectedClass] = useState('knight');
            const [selectedVariant, setSelectedVariant] = useState(0);
            
            const handleStart = () => {
                const charClass = characterClasses[selectedClass];
                const variant = charClass.variants[selectedVariant];
                const characterImage = `${classImageBaseUrl}${variant.image50}`;

                onStartGame({ studentName, level, map, isPractice, characterClass: charClass, characterImage });
            };
            
            const currentClass = characterClasses[selectedClass];
            const currentVariant = currentClass.variants[selectedVariant];
            const largeImageUrl = `${classImageBaseUrl}${currentVariant.image100}`;


            return (
                <div>
                     <h3 className="text-2xl font-bold text-violet-400 text-center mb-8">Prepare for Launch</h3>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-8">
                            {/* Top part: Student, Level, Map */}
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label htmlFor="student" className="text-slate-400 flex items-center gap-2">Student Name <button onClick={() => setShowPrivacyModal(true)} title="Privacy Information" className="text-slate-500 hover:text-violet-400 transition-colors"><IconInfo /></button></label>
                                    <input id="student" type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} className="w-full mt-2 p-3 rounded-md bg-slate-800/60 text-slate-300 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-violet-500" placeholder="For printable report only" />
                                </div>
                                <div>
                                    <label htmlFor="level-select" className="text-slate-400">Passage Level</label>
                                    <select id="level-select" value={level} onChange={e => setLevel(e.target.value)} className="w-full mt-2 p-3 rounded-md bg-slate-800/60 text-slate-300 border border-slate-700">
                                        <option value="2-3">Grades 2-3</option>
                                        <option value="4-5">Grades 4-5</option>
                                        <option value="6-8">Grades 6-8</option>
                                    </select>
                                </div>
                                <div className="md:col-span-2">
                                    <label htmlFor="map-select" className="text-slate-400">Select a Map</label>
                                    <select id="map-select" value={map} onChange={e => setMap(e.target.value)} className="w-full mt-2 p-3 rounded-md bg-slate-800/60 text-slate-300 border border-slate-700">
                                        <option>Jungle of Syntax</option>
                                        <option>Vocabulary Volcano</option>
                                        <option>Caverns of Cohesion</option>
                                    </select>
                                </div>
                                <div className="flex items-center justify-center md:col-span-2">
                                    <label className="flex items-center gap-3 cursor-pointer text-slate-400">
                                        <input type="checkbox" checked={isPractice} onChange={e => setIsPractice(e.target.checked)} className="w-5 h-5 rounded text-violet-600 bg-slate-700 border-slate-600 focus:ring-violet-500"/>
                                        <span>Enable Practice Mode (Provides hints)</span>
                                    </label>
                                </div>
                             </div>
                             {/* Character Selection */}
                            <div>
                                <h4 className="text-xl font-bold text-violet-400 text-center mb-4">Choose Your Class</h4>
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                    {Object.keys(characterClasses).map(key => {
                                        const char = characterClasses[key];
                                        return (
                                            <button key={key} onClick={() => {setSelectedClass(key); setSelectedVariant(0);}} className={`p-2 rounded-lg border-2 transition ${selectedClass === key ? 'border-violet-400 scale-105 bg-violet-900/50' : 'border-slate-700 bg-slate-800/50 hover:bg-slate-700/50'}`}>
                                                <img src={`${classImageBaseUrl}${char.variants[0].image100}`} alt={char.name} className="w-full h-auto rounded-md" />
                                                <p className="text-sm font-bold mt-2">{char.name}</p>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            {/* Class Details & Start Button */}
                            <div className="flex flex-col md:flex-row items-center gap-6 p-4 bg-slate-800/50 rounded-lg">
                               <img src={largeImageUrl} alt={currentClass.name} className="w-24 h-24 rounded-full border-2 border-violet-500"/>
                               <div className="flex-1 text-center md:text-left">
                                   {currentClass.variants.length > 1 && (
                                       <div className="flex gap-2 justify-center md:justify-start mb-2">
                                           {currentClass.variants.map((variant, index) => (
                                                <button key={variant.gender} onClick={() => setSelectedVariant(index)} className={`px-3 py-1 text-xs rounded-full ${selectedVariant === index ? 'bg-violet-600 text-white' : 'bg-slate-700 text-slate-300'}`}>{variant.gender}</button>
                                           ))}
                                       </div>
                                   )}
                                   <p><strong className="text-green-400">Bonus:</strong> {currentClass.bonus}</p>
                                   <p><strong className="text-red-400">Penalty:</strong> {currentClass.penalty}</p>
                               </div>
                               <button onClick={handleStart} className="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition whitespace-nowrap">Begin Literacy Launch</button>
                            </div>
                        </div>
                        {/* Leaderboard */}
                        <div className="p-4 bg-slate-800/50 rounded-lg">
                            <h3 className="text-xl font-bold text-yellow-400 text-center mb-4">Top Scores</h3>
                            <ol className="list-decimal list-inside space-y-2">
                                {leaderboard.map((entry, index) => (
                                    <li key={index} className="flex justify-between">
                                        <span>{entry.pseudonym}</span>
                                        <span className="font-bold">{entry.score}</span>
                                    </li>
                                ))}
                                {leaderboard.length === 0 && <p className="text-slate-400 text-center">No scores yet!</p>}
                            </ol>
                        </div>
                    </div>
                     <PrivacyModal show={showPrivacyModal} onClose={() => setShowPrivacyModal(false)} />
                </div>
            );
        }
        
        // --- Game Screen Component ---
        function GameScreen({ settings, onEndGame }) {
            const { studentName, level, map, isPractice, characterClass, characterImage } = settings;

            const passageData = useMemo(() => {
                const text = passages[level][map];
                const parts = text.split(/(\[.*?\])/g).map((part, index) => {
                    if (part.startsWith('[') && part.endsWith(']')) {
                        const options = part.slice(1, -1).split('|');
                        return { type: 'question', options: options, correct: options[0], id: index };
                    }
                    return { type: 'text', content: part, id: index };
                });
                return parts.filter(p => p.type === 'text' ? p.content.length > 0 : true);
            }, [level, map]);

            const questions = useMemo(() => passageData.filter(p => p.type === 'question'), [passageData]);

            const [startTime] = useState(Date.now());
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState(Array(questions.length).fill(null));
            const [hearts, setHearts] = useState(5 + (characterClass.heartMod || 0));
            const [score, setScore] = useState(0);
            const [streak, setStreak] = useState(0);
            const [lastAnswerCorrect, setLastAnswerCorrect] = useState(null);
            const [selectedOption, setSelectedOption] = useState(null);
            const [isImmune, setIsImmune] = useState(characterClass.immune > 0);
            const [immunityCharges, setImmunityCharges] = useState(characterClass.immune || 0);

            const handleAnswer = (option, questionId) => {
                if (selectedOption) return;

                const question = questions.find(q => q.id === questionId);
                const isCorrect = option === question.correct;
                setSelectedOption({ option, isCorrect });

                setTimeout(() => {
                    if (isCorrect) {
                        correctSound.play();
                        const points = 100 * (characterClass.scoreMod || 1);
                        setScore(prev => prev + points);
                        setStreak(prev => prev + 1);
                        setLastAnswerCorrect(true);
                    } else {
                        incorrectSound.play();
                        if (immunityCharges > 0) {
                            setImmunityCharges(prev => prev - 1);
                        } else {
                            setHearts(prev => Math.max(0, prev - 1));
                        }
                        setStreak(0);
                        setLastAnswerCorrect(false);
                    }

                    const newAnswers = [...answers];
                    const questionIndexInAll = questions.findIndex(q => q.id === questionId);
                    newAnswers[questionIndexInAll] = option;
                    setAnswers(newAnswers);

                    if (currentQuestionIndex < questions.length - 1) {
                         setCurrentQuestionIndex(prev => prev + 1);
                         setSelectedOption(null);
                    } else {
                        // Game over
                        const endTime = Date.now();
                        onEndGame({
                            score,
                            hearts,
                            time: (endTime - startTime) / 1000,
                            correctAnswers: newAnswers.filter((ans, i) => ans === questions[i].correct).length,
                            totalQuestions: questions.length,
                            studentName,
                            level,
                            map,
                            characterClass,
                            characterImage
                        });
                    }
                }, 1000);
            };
            
            if (hearts <= 0) {
                const endTime = Date.now();
                onEndGame({
                    score, hearts, time: (endTime - startTime) / 1000,
                    correctAnswers: answers.filter((ans, i) => ans && ans === questions[i].correct).length,
                    totalQuestions: questions.length,
                    studentName, level, map, characterClass, characterImage
                });
                return <div>Game Over! Redirecting to results...</div>;
            }

            const currentQuestion = questions[currentQuestionIndex];

            return (
                <div className="flex flex-col h-full">
                    <header className="flex justify-between items-center p-4 bg-slate-800/50 rounded-t-lg">
                        <div className="flex items-center gap-3">
                            <img src={characterImage} alt={characterClass.name} className="w-12 h-12 rounded-full border-2 border-violet-400" />
                            <div>
                                <h3 className="font-bold text-lg text-slate-100">{studentName || 'Adventurer'}</h3>
                                <p className="text-sm text-slate-400">{characterClass.name}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4 text-2xl font-bold">
                            <div className="flex items-center gap-2 text-red-500">
                                <IconHeart /> <span>{hearts}</span>
                            </div>
                            <div className="flex items-center gap-2 text-yellow-400">
                                <IconTrophy /> <span>{score}</span>
                            </div>
                        </div>
                    </header>
                    <div className="flex-grow p-6 sm:p-8 bg-slate-900/60 rounded-b-lg">
                        <div className="text-lg md:text-xl text-slate-300 leading-relaxed mb-8">
                            {passageData.map(part => {
                                if (part.type === 'text') {
                                    return <span key={part.id}>{part.content}</span>;
                                }
                                const qIndex = questions.findIndex(q => q.id === part.id);
                                const answer = answers[qIndex];
                                if (answer) {
                                    const isCorrect = answer === part.correct;
                                    return <strong key={part.id} className={isCorrect ? 'text-green-400' : 'text-red-400 line-through'}>{answer}</strong>;
                                }
                                if (qIndex === currentQuestionIndex) {
                                     return <strong key={part.id} className="text-violet-400 bg-slate-800 px-2 py-1 rounded-md"> [ ? ] </strong>;
                                }
                                return <span key={part.id}>____</span>;
                            })}
                        </div>
                        
                        <div className="mt- auto">
                            <h4 className="text-xl font-bold text-center text-slate-100 mb-4">Choose the best word:</h4>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                {currentQuestion.options.map(option => {
                                    const isSelected = selectedOption && selectedOption.option === option;
                                    const buttonClass = isSelected
                                        ? (selectedOption.isCorrect ? 'bg-green-600' : 'bg-red-600')
                                        : 'bg-slate-700 hover:bg-slate-600';

                                    return (
                                        <button key={option} onClick={() => handleAnswer(option, currentQuestion.id)} disabled={!!selectedOption}
                                            className={`p-4 rounded-lg text-white font-semibold text-lg transition ${buttonClass}`}>
                                            {option}
                                        </button>
                                    );
                                })}
                            </div>
                            {isPractice && !selectedOption && <p className="text-center text-slate-400 mt-4 text-sm">Hint: The correct answer is <strong className="italic">{currentQuestion.correct}</strong>.</p>}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Results Screen Component ---
        function ResultsScreen({ results, onRestart, leaderboard, onUpdateLeaderboard }) {
            const { score, hearts, time, correctAnswers, totalQuestions, studentName, level, map, characterClass, characterImage } = results;
            const accuracy = totalQuestions > 0 ? (correctAnswers / totalQuestions * 100).toFixed(1) : 0;
            const [pseudonym, setPseudonym] = useState('');
            const [submitted, setSubmitted] = useState(false);

            const handleSubmitScore = () => {
                // In a real environment, this would be a POST request.
                // fetch('/api/literacy-launchpad/leaderboard', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ pseudonym, score, level, map, character: characterClass.name })
                // })
                // .then(() => {
                //     setSubmitted(true);
                //     onUpdateLeaderboard(); // Refresh leaderboard data
                // })
                // .catch(err => console.error("Failed to submit score:", err));

                console.log("Submitting score (mocked for preview):", { pseudonym, score });
                setSubmitted(true);
            };
            
             const handlePrint = () => {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Literacy Launchpad Report</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <style> body { font-family: sans-serif; background-color: #1a202c; color: #e2e8f0; } </style>
                        </head>
                        <body class="p-8">
                            <div class="max-w-4xl mx-auto bg-slate-800 p-8 rounded-lg shadow-lg border border-violet-700">
                                <h1 class="text-4xl font-bold text-violet-400 mb-2">Literacy Launchpad Report</h1>
                                <p class="text-lg text-slate-400 mb-6">For: ${studentName || 'N/A'}</p>
                                
                                <div class="grid grid-cols-2 gap-6 text-center">
                                    <div class="bg-slate-700 p-4 rounded-lg">
                                        <p class="text-sm text-slate-400">Final Score</p>
                                        <p class="text-3xl font-bold text-yellow-400">${score}</p>
                                    </div>
                                     <div class="bg-slate-700 p-4 rounded-lg">
                                        <p class="text-sm text-slate-400">Accuracy</p>
                                        <p class="text-3xl font-bold text-green-400">${accuracy}%</p>
                                    </div>
                                    <div class="bg-slate-700 p-4 rounded-lg">
                                        <p class="text-sm text-slate-400">Time Taken</p>
                                        <p class="text-3xl font-bold text-cyan-400">${time.toFixed(1)}s</p>
                                    </div>
                                     <div class="bg-slate-700 p-4 rounded-lg">
                                        <p class="text-sm text-slate-400">Hearts Remaining</p>
                                        <p class="text-3xl font-bold text-red-400">${hearts}</p>
                                    </div>
                                </div>

                                <div class="mt-8">
                                    <h2 class="text-2xl font-bold text-slate-100 mb-4">Session Details</h2>
                                    <ul class="space-y-2 text-slate-300">
                                        <li><strong>Level:</strong> Grades ${level}</li>
                                        <li><strong>Map:</strong> ${map}</li>
                                        <li><strong>Class:</strong> ${characterClass.name}</li>
                                    </ul>
                                </div>
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            };

            return (
                <div className="text-center">
                    <h2 className="text-4xl font-bold text-violet-400 mb-2">Adventure Complete!</h2>
                    <p className="text-lg text-slate-300 mb-8">Here's how you did, {studentName || 'adventurer'}.</p>

                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 max-w-4xl mx-auto mb-8">
                        <div className="bg-slate-800/70 p-4 rounded-lg flex flex-col items-center justify-center">
                            <IconTrophy />
                            <p className="mt-2 text-slate-400">Score</p>
                            <p className="text-3xl font-bold text-yellow-400">{score}</p>
                        </div>
                        <div className="bg-slate-800/70 p-4 rounded-lg flex flex-col items-center justify-center">
                             <IconCheckCircle />
                            <p className="mt-2 text-slate-400">Accuracy</p>
                            <p className="text-3xl font-bold text-green-400">{accuracy}%</p>
                        </div>
                         <div className="bg-slate-800/70 p-4 rounded-lg flex flex-col items-center justify-center">
                             <IconClock />
                            <p className="mt-2 text-slate-400">Time</p>
                            <p className="text-3xl font-bold text-cyan-400">{time.toFixed(1)}s</p>
                        </div>
                        <div className="bg-slate-800/70 p-4 rounded-lg flex flex-col items-center justify-center">
                            <IconHeart className="w-6 h-6"/>
                            <p className="mt-2 text-slate-400">Hearts</p>
                            <p className="text-3xl font-bold">{hearts}</p>
                        </div>
                    </div>
                    
                    {!submitted && (
                         <div className="max-w-md mx-auto my-8 p-4 bg-slate-800 rounded-lg">
                            <h3 className="text-lg font-bold text-yellow-400">Add to Leaderboard?</h3>
                            <p className="text-sm text-slate-400 mb-3">Enter a name to appear on the Top Scores list.</p>
                            <div className="flex gap-2">
                                <input type="text" value={pseudonym} onChange={e => setPseudonym(e.target.value)} placeholder="Enter a pseudonym" className="flex-grow p-2 rounded-md bg-slate-700 text-slate-200 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" />
                                <button onClick={handleSubmitScore} disabled={!pseudonym} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition disabled:bg-slate-600 disabled:cursor-not-allowed">Submit</button>
                            </div>
                        </div>
                    )}
                    {submitted && <p className="text-green-400 my-8">Score submitted to leaderboard!</p>}

                    <div className="flex justify-center gap-4 mt-8">
                        <button onClick={onRestart} className="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-6 rounded-lg transition">Play Again</button>
                        {studentName && <button onClick={handlePrint} className="bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg transition">Print Report</button>}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
{% endraw %}
{% endblock %}


