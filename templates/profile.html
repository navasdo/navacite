{% extends "base.html" %}
{% block content %}
<style>
    /* Tooltip styles for achievements */
    .achievement-badge .tooltip-text {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    .achievement-badge:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    /* Hide input fields in view mode */
    .view-mode .editable-input {
        display: none;
    }
    /* Show text fields in view mode */
    .view-mode .view-text {
        display: block;
    }
    /* Vice-versa for edit mode */
    .edit-mode .editable-input {
        display: block;
    }
    .edit-mode .view-text {
        display: none;
    }
    .edit-mode .username-static {
        color: #94a3b8; /* A slate-400 color */
        cursor: not-allowed;
    }
</style>
<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <div id="profile-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8 view-mode">
            <!-- Left Column -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Profile Card -->
                <div class="bg-slate-900/40 p-6 rounded-2xl shadow-lg border border-violet-900/80 text-center">
                    <div class="relative w-40 h-40 mx-auto group">
                        <!-- The src is now dynamically set from the server or placeholder -->
                        <img id="profile-pic" class="rounded-full w-full h-full object-cover border-4 border-violet-700" src="{{ user.profile_photo_url or 'https://placehold.co/160x160/1e293b/a78bfa?text=' + (user.username[0]|upper) }}" alt="Profile Photo">
                        <label for="photo-upload" class="editable-input absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
                            Upload
                        </label>
                        <input type="file" id="photo-upload" class="hidden" accept="image/*">
                    </div>
                    <div class="mt-4">
                        <!-- Primary and Secondary Name Display -->
                        <div class="view-text">
                            <div class="text-2xl font-bold text-slate-100">
                                {{ user.display_name or user.username }}
                            </div>
                            <div class="text-violet-400 text-sm">
                                {% if user.display_preference == 'real_name' %}
                                    {{ user.username }}
                                {% else %}
                                    {{ user.real_name or '' }}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Edit Mode Name Fields -->
                        <div class="editable-input space-y-3 mt-2">
                             <div class="text-lg font-bold text-slate-500 username-static" title="Username cannot be changed.">{{ user.username }}</div>
                             <input type="text" id="real-name-input" class="w-full bg-slate-800/60 border border-slate-700 rounded-lg p-2 text-center text-base" value="{{ user.real_name or '' }}" placeholder="Your Real Name">
                             
                             <fieldset class="text-left text-sm text-slate-300 pt-2">
                                <legend class="font-semibold pb-2 text-center">Primary Display Name:</legend>
                                <div class="flex justify-center space-x-6">
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="display_preference" value="username" class="form-radio bg-slate-700 border-slate-600 text-violet-500 focus:ring-violet-500" {% if user.display_preference != 'real_name' %}checked{% endif %}>
                                        <span>Username</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="display_preference" value="real_name" class="form-radio bg-slate-700 border-slate-600 text-violet-500 focus:ring-violet-500" {% if user.display_preference == 'real_name' %}checked{% endif %}>
                                        <span>Real Name</span>
                                    </label>
                                </div>
                             </fieldset>
                        </div>
                        
                        <!-- Location -->
                        <div class="view-text text-slate-400 mt-2" id="location-text">{{ user.location or 'Location not specified' }}</div>
                        <input type="text" id="location-input" class="editable-input w-full bg-slate-800/60 border border-slate-700 rounded-lg p-1 mt-2 text-center text-sm" value="{{ user.location or '' }}" placeholder="Your Location">
                    </div>
                    
                    {% if is_own_profile %}
                        <button id="edit-profile-btn" class="mt-6 w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition">Edit Profile</button>
                    {% else %}
                        <button id="follow-btn" class="mt-6 w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition">Follow</button>
                    {% endif %}
                </div>

                <!-- Achievements -->
                <div class="bg-slate-900/40 p-6 rounded-2xl shadow-lg border border-violet-900/80">
                    <h3 class="text-xl font-bold text-violet-400 mb-4">Achievements</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <!-- Achievements remain the same -->
                         <div class="achievement-badge relative" title="Member for 1 Year">
                            <img src="https://placehold.co/80x80/334155/4f46e5?text=1Y" alt="1 Year Member" class="rounded-full filter grayscale hover:grayscale-0">
                            <div class="tooltip-text absolute bottom-full mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2">Member for 1 Year</div>
                        </div>
                        <div class="achievement-badge relative" title="Contributed to the Library I">
                             <img src="https://placehold.co/80x80/334155/4f46e5?text=C1" alt="Contributor I" class="rounded-full filter grayscale hover:grayscale-0">
                             <div class="tooltip-text absolute bottom-full mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2">Contribute a valid bug report or suggestion.</div>
                        </div>
                        <div class="achievement-badge relative" title="Contributed to the Library II">
                             <img src="https://placehold.co/80x80/334155/4f46e5?text=C2" alt="Contributor II" class="rounded-full filter grayscale hover:grayscale-0">
                             <div class="tooltip-text absolute bottom-full mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2">Have 5 contributions implemented.</div>
                        </div>
                        <div class="achievement-badge relative" title="Early Adopter">
                             <img src="https://placehold.co/80x80/334155/4f46e5?text=EA" alt="Early Adopter" class="rounded-full">
                             <div class="tooltip-text absolute bottom-full mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2">Joined during the Alpha phase.</div>
                        </div>
                        <div class="achievement-badge relative" title="Community Builder">
                             <img src="https://placehold.co/80x80/334155/4f46e5?text=CB" alt="Community Builder" class="rounded-full filter grayscale hover:grayscale-0">
                             <div class="tooltip-text absolute bottom-full mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2">Follow 10 other professionals.</div>
                        </div>
                         <div class="achievement-badge relative" title="Feedback Champion">
                             <img src="https://placehold.co/80x80/334155/4f46e5?text=FC" alt="Feedback Champion" class="rounded-full filter grayscale hover:grayscale-0">
                             <div class="tooltip-text absolute bottom-full mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2">Provide detailed feedback on 3 tools.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- About Me -->
                <div class="bg-slate-900/40 p-6 rounded-2xl shadow-lg border border-violet-900/80">
                    <h3 class="text-xl font-bold text-violet-400 mb-4">About Me</h3>
                    <div id="about-text" class="view-text text-slate-400 whitespace-pre-wrap">{{ user.about_me or 'This professional has not yet written their summary.' }}</div>
                     <textarea id="about-editor" class="editable-input w-full bg-slate-800/60 border border-slate-700 rounded-lg p-4 text-slate-300" rows="5">{{ user.about_me or '' }}</textarea>
                </div>

                <!-- Professional Details -->
                <div class="bg-slate-900/40 p-6 rounded-2xl shadow-lg border border-violet-900/80">
                     <h3 class="text-xl font-bold text-violet-400 mb-4">Professional Details</h3>
                     <div class="space-y-6">
                         <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Field(s) of Work</h4>
                            <!-- View mode for fields -->
                            <div id="fields-view-container" class="view-text flex flex-wrap gap-2">
                                {% for field in user.fields or [] %}
                                <span class="bg-violet-800/50 text-violet-300 text-sm font-medium px-3 py-1 rounded-full">{{ field }}</span>
                                {% endfor %}
                            </div>
                            <!-- Edit mode for fields (checkboxes) -->
                            <div id="fields-edit-container" class="editable-input grid grid-cols-2 md:grid-cols-3 gap-4">
                                {% set work_fields = ['K-12', 'Early Childhood', 'Hospital', 'Outpatient', 'Private Practice', 'Nursing Home', 'Skilled Nursing Facility', 'Higher Ed.', 'Teletherapy'] %}
                                {% for field in work_fields %}
                                <label class="flex items-center space-x-2 text-slate-300">
                                    <input type="checkbox" name="fields" value="{{ field }}" class="form-checkbox bg-slate-700 border-slate-600 text-violet-500 focus:ring-violet-500" {% if field in (user.fields or []) %}checked{% endif %}>
                                    <span>{{ field }}</span>
                                </label>
                                {% endfor %}
                            </div>
                         </div>
                         <!-- Areas of Interest -->
                         <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Areas of Interest</h4>
                             <div id="interests-container" class="flex flex-wrap gap-2" data-bubbles='{{ user.interests|tojson }}'></div>
                             <input type="text" id="interests-input" class="editable-input w-full bg-slate-800/60 border border-slate-700 rounded-lg p-2 mt-2" placeholder="Add an interest and press Enter...">
                         </div>
                         <!-- Hobbies -->
                          <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Hobbies</h4>
                             <div id="hobbies-container" class="flex flex-wrap gap-2" data-bubbles='{{ user.hobbies|tojson }}'></div>
                              <input type="text" id="hobbies-input" class="editable-input w-full bg-slate-800/60 border border-slate-700 rounded-lg p-2 mt-2" placeholder="Add a hobby and press Enter...">
                         </div>
                         <!-- Specializations -->
                         <div>
                            <h4 class="font-semibold text-slate-200 mb-2">Specializations</h4>
                             <div id="specializations-container" class="flex flex-wrap gap-2" data-bubbles='{{ user.specializations|tojson }}'></div>
                             <input type="text" id="specializations-input" class="editable-input w-full bg-slate-800/60 border border-slate-700 rounded-lg p-2 mt-2" placeholder="Add a specialization and press Enter...">
                         </div>
                     </div>
                </div>

                <!-- Contact / Collaborate -->
                 <div class="bg-slate-900/40 p-6 rounded-2xl shadow-lg border border-violet-900/80">
                    {% if is_own_profile %}
                        <h3 class="text-xl font-bold text-violet-400 mb-2">Contact Information</h3>
                        <p class="text-xs text-slate-500 mb-4">This section is only visible to you.</p>
                        <div>
                            <label for="email-input" class="font-semibold text-slate-200">Your Email</label>
                            <div class="view-text text-slate-400 mt-2">{{ user.email or 'No email provided' }}</div>
                            <input id="email-input" type="email" class="editable-input w-full bg-slate-800/60 border border-slate-700 rounded-lg p-2 mt-2" value="{{ user.email or '' }}" placeholder="youremail@example.com">
                            <p class="text-xs text-slate-500 mt-2">Others will see a "Request to Collaborate" button. If you approve their request, they will receive your email address.</p>
                        </div>
                    {% else %}
                        <h3 class="text-xl font-bold text-violet-400 mb-4">Collaboration</h3>
                        <button 
                            id="collaborate-btn" 
                            data-recipient-username="{{ user.username }}"
                            class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-6 rounded-lg transition">
                            Request to Collaborate
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let isEditMode = false;
        let profilePhotoBase64 = null; // NEW: To store the new photo data
        const profileContainer = document.getElementById('profile-container');
        const editBtn = document.getElementById('edit-profile-btn');
        
        if (editBtn) {
            editBtn.addEventListener('click', toggleEditMode);
        }

        function setupBubbleInput(inputId, containerId) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            try {
                const existingBubbles = JSON.parse(container.dataset.bubbles || '[]');
                existingBubbles.forEach(text => addBubble(text, container));
            } catch(e) { console.error("Could not parse bubbles:", container.dataset.bubbles); }

            input.addEventListener('keydown', function(event) {
                if (isEditMode && (event.key === 'Enter' || event.key === ',' || event.key === 'Tab')) {
                    event.preventDefault();
                    const text = input.value.trim();
                    if (text) {
                        addBubble(text, container);
                        input.value = '';
                    }
                }
            });
        }

        function addBubble(text, container) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble bg-slate-700 text-slate-300 text-sm font-medium pl-3 pr-2 py-1 rounded-full flex items-center gap-2';
            bubble.textContent = text;
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'w-4 h-4 bg-slate-500 rounded-full flex items-center justify-center text-white text-xs hover:bg-red-500';
            removeBtn.onclick = () => { if(isEditMode) bubble.remove(); };
            bubble.appendChild(removeBtn);
            container.appendChild(bubble);
        }

        setupBubbleInput('interests-input', 'interests-container');
        setupBubbleInput('hobbies-input', 'hobbies-container');
        setupBubbleInput('specializations-input', 'specializations-container');

        function toggleEditMode() {
            isEditMode = !isEditMode;
            profileContainer.classList.toggle('view-mode', !isEditMode);
            profileContainer.classList.toggle('edit-mode', isEditMode);
            editBtn.textContent = isEditMode ? 'Save Changes' : 'Edit Profile';
            editBtn.classList.toggle('bg-slate-700', !isEditMode);
            editBtn.classList.toggle('hover:bg-slate-600', !isEditMode);
            editBtn.classList.toggle('bg-green-600', isEditMode);
            editBtn.classList.toggle('hover:bg-green-700', isEditMode);
            if (!isEditMode) {
                saveProfileData();
            }
        }
        
        async function saveProfileData() {
            const getBubbleData = (containerId) => {
                const bubbles = document.querySelectorAll(`#${containerId} .bubble`);
                return Array.from(bubbles).map(b => b.textContent.slice(0, -1));
            };
            const selectedFields = Array.from(document.querySelectorAll('input[name="fields"]:checked')).map(cb => cb.value);
            const displayPreference = document.querySelector('input[name="display_preference"]:checked').value;

            const profileData = {
                real_name: document.getElementById('real-name-input').value,
                location: document.getElementById('location-input').value,
                about_me: document.getElementById('about-editor').value,
                email: document.getElementById('email-input').value,
                fields: selectedFields,
                interests: getBubbleData('interests-container'),
                hobbies: getBubbleData('hobbies-container'),
                specializations: getBubbleData('specializations-container'),
                display_preference: displayPreference,
                profile_photo_b64: profilePhotoBase64 // NEW: Add photo data to payload
            };

            if (!validateAboutText(profileData.about_me)) {
                alert("Your 'About Me' section contains prohibited content. Please revise.");
                toggleEditMode();
                return;
            }

            try {
                const response = await fetch('/api/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save profile.');
                }
                window.location.reload();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error: ' + error.message);
                toggleEditMode();
            }
        }

        function validateAboutText(text) {
            const forbiddenWords = ['politics', 'religion', 'racism', 'bigotry'];
            const lowerText = text.toLowerCase();
            return !forbiddenWords.some(word => lowerText.includes(word));
        }
        
        // --- UPDATED: Collaborate Button Logic ---
        const collaborateBtn = document.getElementById('collaborate-btn');
        if (collaborateBtn) {
            collaborateBtn.addEventListener('click', async () => {
                const recipientUsername = collaborateBtn.dataset.recipientUsername;
                collaborateBtn.disabled = true;
                collaborateBtn.textContent = 'Sending...';

                try {
                    const response = await fetch('/api/collaborate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipient_username: recipientUsername }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to send request.');
                    }
                    
                    collaborateBtn.textContent = 'Request Sent!';
                    collaborateBtn.classList.add('bg-slate-600');
                    collaborateBtn.classList.remove('bg-violet-600', 'hover:bg-violet-700');

                } catch (error) {
                    console.error('Collaboration request failed:', error);
                    alert('Error: ' + error.message);
                    collaborateBtn.textContent = 'Request to Collaborate';
                    collaborateBtn.disabled = false;
                }
            });
        }
        
        // --- Profile Photo Upload and Preview Logic ---
        document.getElementById('photo-upload').addEventListener('change', function(event){
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Update the image preview on the page
                    document.getElementById('profile-pic').src = e.target.result;
                    // Store the base64 string to be sent to the server
                    profilePhotoBase64 = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    });
    </script>
{% endblock  %}


