{% extends "base.html" %}

{% block title %}Session Scribe{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        /* Custom styles for the magical loading indicator */
        @keyframes pulse {
            0%, 100% { transform: scale(0.5); opacity: 0; }
            50% { opacity: 0.7; }
            75% { transform: scale(1); opacity: 0; }
        }
        
        /* Modal Animation Styles */
        .modal {
            transition: opacity 300ms ease-in-out;
        }
        .modal-content {
            transition: opacity 300ms ease-in-out, transform 300ms ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal:not(.hidden) {
            opacity: 1;
        }
        .modal.hidden .modal-content {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal:not(.hidden) .modal-content {
            opacity: 1;
            transform: scale(1);
        }

        /* Custom scrollbar for modals */
        .modal-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .modal-scroll::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        .modal-scroll::-webkit-scrollbar-thumb {
            background-color: #4c1d95; /* violet-800 */
            border-radius: 10px;
            border: 2px solid #1e293b;
        }
    </style>
{% endblock %}

{% block content %}
    <div id="app-root" class="min-h-screen flex flex-col">
        <!-- The entire application will be rendered here by JavaScript -->
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // --- Shorthand Glossary ---
        const shorthandGlossary = {
            "tx": "therapy", "acc": "accuracy", "ST": "speech therapy", "SPED / SE": "special education", "IEP": "Individualized Education Program", "prog mon / PM": "progress monitoring", "lvl / gr": "grade level", "rdg comp / rc": "reading comprehension", "wrt": "writing", "exp lang": "expressive language", "rec lang": "receptive language", "artic": "articulation", "phon": "phonological skills", "flu / fl": "fluency", "soc com / prag": "social communication / pragmatic language", "voc": "vocabulary", "sem": "semantics", "syn": "syntax", "aud comp / AL": "auditory comprehension / auditory listening", "exec fxn / EF": "executive functioning", "beh": "behavior", "attn": "attention", "prac": "practice", "hw": "homework", "indep": "independent", "mod": "moderate", "min": "minimal", "max": "maximum", "cues / cued": "prompting / cues", "grp": "group", "1:1": "one-on-one", "SLP": "Speech-Language Pathologist", "SW": "social worker", "OT": "occupational therapy", "PT": "physical therapy", "AAC": "augmentative and alternative communication", "FAPE": "Free Appropriate Public Education", "LRE": "Least Restrictive Environment", "mtg": "meeting", "collab": "collaboration", "gen ed": "general education", "sped staff / se staff": "special education staff", "ALE": "alternative learning environment", "IA": "Independence Academy", "DDSEC": "Don Sherrill Education Center", "NEC": "Nuernberger Education Center", "YH": "Yankee Hill", "SSP": "Student Support Program", "ISP": "Individual Success Program", "GP": "Graduation Pathways", "Bryan / BC": "Bryan Community", "WH": "Whitehall", "EC": "Early Childhood", "LS": "Life Skills", "ID": "Intellectual Disability", "aut": "Autism", "ASD": "Autism Spectrum Disorder", "ED": "Emotional Disability", "SED": "Social-Emotional Disability", "DD": "Developmental Delay", "VI": "Visual Impairment", "HI": "Hearing Impairment", "TBI": "Traumatic Brain Injury", "AT": "Assistive Technology", "PECS": "Picture Exchange Communication System", "SRT": "Student Response to Intervention", "RTI": "Response to Intervention", "BIP": "Behavior Intervention Plan", "FBA": "Functional Behavior Assessment", "BCBA": "Board Certified Behavior Analyst", "PLAAFP": "Present Levels of Academic Achievement and Functional Performance", "PLOP": "Present Levels of Performance", "CO-TX / cotx / co tx": "Co-therapy", "DIS": "Direct Instructional Support", "EL": "English Learner", "ELL": "English Language Learner", "CALP/ BICS": "Cognitive Academic Language Proficiency / Basic Interpersonal Communication Skills", "SCA": "Social Communication Assessment", "TELD": "Test of Early Language Development", "CELF": "Clinical Evaluation of Language Fundamentals", "OWLS": "Oral and Written Language Scales", "CASL": "Comprehensive Assessment of Spoken Language", "EVT": "Expressive Vocabulary Test", "PPVT": "Peabody Picture Vocabulary Test", "IDD": "Intellectual and Developmental Disabilities", "AAC eval": "AAC evaluation", "MTSS": "Multi-Tiered System of Supports"
        };
        const knownAcronyms = new Set(Object.keys(shorthandGlossary).map(k => k.toUpperCase().split(' / ')[0]));

        // --- App State ---
        let state = {
            screen: 'setup',
            isLoading: false,
            error: null,
            userInput: '',
            generatedNote: '',
            showComplianceModal: false,
            showGlossaryModal: false,
            potentialViolations: [], 
        };

        // --- Core App Logic ---

        function setState(newState) {
            if (state.error) {
                clearTimeout(state.errorTimer);
            }
            Object.assign(state, newState);
            render();
        }
        
        async function handleApiError(response) {
            const errorData = await response.json().catch(() => ({}));
            const detailText = typeof errorData.details === 'string' ? ` Details: ${errorData.details}` : '';
            throw new Error(errorData.error || `Server Error: ${response.statusText}${detailText}`);
        }

        const handleScribeClick = async () => {
            if (!state.userInput.trim()) {
                const timer = setTimeout(() => setState({ error: null }), 5000);
                setState({ error: "Please enter your notes before scribing.", errorTimer: timer });
                return;
            }
            setState({ isLoading: true, error: null });

            try {
                const response = await fetch('/api/compliance-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userInput: state.userInput }) 
                });

                if (!response.ok) await handleApiError(response);
                
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) {
                    await generateFinalNote();
                    return;
                }

                const data = JSON.parse(jsonText);
                const violations = data.violations || [];
                const finalViolations = violations.filter(v => !knownAcronyms.has(v.toUpperCase()));

                if (finalViolations.length > 0) {
                    setState({ isLoading: false, showComplianceModal: true, potentialViolations: finalViolations });
                } else {
                    await generateFinalNote();
                }

            } catch (err) {
                const timer = setTimeout(() => setState({ error: null }), 8000);
                setState({ isLoading: false, error: err.message, errorTimer: timer });
            }
        };

        const generateFinalNote = async () => {
            setState({ isLoading: true, error: null, showComplianceModal: false });

            try {
                const response = await fetch('/api/generate-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userInput: state.userInput,
                        glossary: shorthandGlossary 
                    })
                });

                if (!response.ok) await handleApiError(response);

                const result = await response.json();
                const note = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (note) {
                    const today = new Date();
                    const datePlaceholder = `${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
                    const datedNote = `${datePlaceholder}: ${note}`;
                    setState({ generatedNote: datedNote, screen: 'results', isLoading: false });
                } else {
                    throw new Error("Failed to generate a valid note from the AI service. The response was empty.");
                }
            } catch (err) {
                const timer = setTimeout(() => setState({ error: null }), 8000);
                setState({ isLoading: false, error: err.message, errorTimer: timer });
            }
        };

        // --- HTML Template Generators ---

        function SetupScreenHTML() {
            const today = new Date();
            const datePlaceholder = `${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
            const placeholderText = `e.g., grp tx, artic, /r/, initial pos, min cues, 75% acc.\n\n...becomes...\n\n${datePlaceholder}: Student participated in a group therapy session targeting articulation of the /r/ sound in the initial position of words, achieving 75% accuracy with minimal cues.`;
            
            if(state.isLoading) {
                return `<div class="flex justify-center items-center h-40"><div class="relative w-16 h-16">${[...Array(3)].map((_, i) => `<div class="absolute inset-0 rounded-full bg-violet-500 opacity-0" style="animation: pulse 2.5s ease-in-out infinite; animation-delay: ${i * 0.4}s; box-shadow: 0 0 10px #8b5cf6, 0 0 20px #8b5cf6;"></div>`).join('')}</div></div>`;
            }

            return `
                <div class="space-y-6">
                    <div>
                        <textarea id="userInput" rows="7" class="w-full bg-slate-800/60 border border-slate-700 rounded-lg p-4 text-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 focus:outline-none transition" placeholder="${placeholderText}">${state.userInput}</textarea>
                    </div>
                    <div class="pt-4 flex flex-col sm:flex-row justify-center items-center gap-6">
                        <button id="scribe-button" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition-colors w-full sm:w-auto flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 16V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2a2 2 0 0 1 2-2h2z"/><path d="M16 2v4"/><path d="M18 4a2 2 0 0 0-2-2h-1"/></svg>
                             Ready to Scribe
                        </button>
                        <button id="tome-button" class="p-2 rounded-md border border-slate-700 bg-slate-800/60 hover:bg-[#3e2e6b] text-slate-300 font-bold py-3 px-8 transition-all duration-200 ease-in-out w-full sm:w-auto flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                            Shorthand Tome
                        </button>
                    </div>
                </div>
            `;
        }

        function ResultsScreenHTML() {
            return `
                <div class="space-y-6">
                    <h3 class="text-xl font-bold text-violet-400 text-center">Your Scribed Note</h3>
                    <div class="relative bg-slate-800/60 border border-slate-700 rounded-lg p-4 min-h-[150px]">
                        <p class="text-slate-300 whitespace-pre-wrap pr-12">${state.generatedNote}</p>
                        <button id="copy-button" class="absolute top-2 right-2 p-2 text-slate-400 hover:text-white transition rounded-md" title="Copy to Clipboard">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>
                        </button>
                    </div>
                    <div class="pt-4 text-center">
                         <button id="restart-button" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition-colors flex items-center justify-center gap-2 mx-auto">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>
                           Start a New Note
                        </button>
                    </div>
                </div>
            `;
        }
        
        function ModalHTML(id, content, show) {
            return `
                <div id="${id}" class="modal ${show ? '' : 'hidden'} fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div class="modal-content bg-slate-900 rounded-2xl shadow-2xl shadow-violet-500/10 border border-violet-700 w-full max-h-[90vh] flex flex-col ${id === 'glossary-modal' ? 'max-w-2xl' : 'max-w-md'}">
                        ${content}
                    </div>
                </div>
            `;
        }
        
        function ComplianceModalContent() {
            const violationText = state.potentialViolations.map(v => `<strong class="text-red-400">${v}</strong>`).join(', ');
            return `
                <div class="p-8 text-center space-y-6">
                    <h3 class="text-xl font-bold text-violet-400">Compliance Check</h3>
                    <p class="text-slate-400">To protect privacy and comply with FERPA, no personally identifiable information should be scribed.</p>
                    <p class="text-slate-400 bg-slate-800 p-3 rounded-md">The following terms may be a violation: ${violationText}. Do you confirm your entry is compliant?</p>
                    <div class="flex justify-center gap-4 pt-4">
                        <button id="comply-cancel" class="py-2 px-6 bg-slate-600 text-white font-bold rounded-lg hover:bg-slate-700 transition w-1/2">No, I'll Edit</button>
                        <button id="comply-confirm" class="py-2 px-6 bg-violet-600 text-white font-bold rounded-lg hover:bg-violet-700 transition w-1/2">Yes, Proceed</button>
                    </div>
                </div>
            `;
        }

        function GlossaryModalContent() {
            const sortedGlossary = Object.entries(shorthandGlossary).sort((a, b) => a[0].localeCompare(b[0]));
            return `
                <div class="p-6 flex flex-col flex-grow min-h-0">
                    <h3 class="text-xl font-bold text-violet-400 text-center mb-4">Shorthand Tome</h3>
                    <div class="overflow-y-auto flex-grow pr-2 text-left modal-scroll">
                        <table class="w-full text-slate-300">
                            <thead class="sticky top-0 bg-slate-900">
                                <tr class="border-b border-violet-900/80">
                                    <th class="p-2 font-semibold text-left">Shorthand</th>
                                    <th class="p-2 font-semibold text-left">Expansion</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedGlossary.map(([key, value]) => `
                                    <tr class="border-b border-slate-800">
                                        <td class="p-2 align-top font-mono text-sm w-1/3">${key}</td>
                                        <td class="p-2 align-top text-slate-400">${value}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <button id="glossary-close" class="mt-6 py-3 px-8 bg-violet-600 text-white font-bold rounded-lg hover:bg-violet-700 transition w-full sm:w-1/2 mx-auto">
                        Close Tome
                    </button>
                </div>
            `;
        }
        
        // --- Main Render Function ---
        const appRoot = document.getElementById('app-root');

        function render() {
            const screenHTML = state.screen === 'setup' ? SetupScreenHTML() : ResultsScreenHTML();
            const complianceModal = ModalHTML('compliance-modal', ComplianceModalContent(), state.showComplianceModal);
            const glossaryModal = ModalHTML('glossary-modal', GlossaryModalContent(), state.showGlossaryModal);
            
            const errorHTML = state.error ? `<div class="border border-red-500 bg-red-900/40 text-red-400 p-3 rounded-lg text-center my-4 max-w-5xl mx-auto">${state.error}</div>` : '';

            appRoot.innerHTML = `
                ${complianceModal}
                ${glossaryModal}
                <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl flex-grow">
                    <header class="text-center mb-10">
                        <img src="https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/static/navacite-images/navacite-session-scribe-2.png" alt="Session Scribe icon" class="w-48 mx-auto mb-4 [filter:drop-shadow(0_0_15px_rgba(255,255,255,0.3))]"/>
                        <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-500">Session Scribe</h1>
                        <p class="text-slate-400 italic mt-2">Transform your shorthand therapy notes into professional, compliant documentation.</p>
                    </header>
                    ${errorHTML}
                    <main class="bg-slate-900/40 p-6 sm:p-8 rounded-2xl shadow-lg border border-violet-900/80">
                        ${screenHTML}
                    </main>
                </div>
            `;

            addEventListeners();
        }
        
        function addEventListeners() {
            if (state.screen === 'setup') {
                document.getElementById('scribe-button')?.addEventListener('click', handleScribeClick);
                document.getElementById('tome-button')?.addEventListener('click', () => setState({ showGlossaryModal: true }));
                const userInputEl = document.getElementById('userInput');
                if (userInputEl) {
                    userInputEl.addEventListener('input', e => { state.userInput = e.target.value; });
                    userInputEl.focus();
                }
            } else {
                document.getElementById('restart-button')?.addEventListener('click', () => setState({ screen: 'setup', userInput: '', generatedNote: '' }));
                const copyButton = document.getElementById('copy-button');
                if (copyButton) {
                    copyButton.addEventListener('click', () => {
                        const tempTextArea = document.createElement('textarea');
                        tempTextArea.value = state.generatedNote;
                        // Make it non-editable and position off-screen
                        tempTextArea.setAttribute('readonly', '');
                        tempTextArea.style.position = 'absolute';
                        tempTextArea.style.left = '-9999px';

                        document.body.appendChild(tempTextArea);
                        tempTextArea.select();
                        
                        try {
                            document.execCommand('copy');
                            
                            // Visual feedback for success
                            const originalContent = copyButton.innerHTML;
                            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M20 6 9 17l-5-5"/></svg>`;
                            copyButton.title = "Copied!";
                            copyButton.disabled = true;

                            setTimeout(() => {
                                copyButton.innerHTML = originalContent;
                                copyButton.title = "Copy to Clipboard";
                                copyButton.disabled = false;
                            }, 2000);

                        } catch (err) {
                            console.error('Oops, unable to copy to clipboard', err);
                        }

                        document.body.removeChild(tempTextArea);
                    });
                }
            }
            
            // Modal Listeners
            document.getElementById('comply-cancel')?.addEventListener('click', () => setState({ showComplianceModal: false, potentialViolations: [] }));
            document.getElementById('comply-confirm')?.addEventListener('click', generateFinalNote);
            document.getElementById('glossary-close')?.addEventListener('click', () => setState({ showGlossaryModal: false }));
        }
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', render);

    </script>
{% endblock %}

