{% extends "base.html" %}

{% block title %}Articulation: Mystical Mirror{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        html {
            scroll-behavior: smooth;
        }
        #drill-container {
            display: none; /* Initially hidden */
        }
        /* Style for the canvas and controls */
        #colorPlot {
            background-color: #000;
            border-radius: 0.5rem;
        }
        .spectrogram-controls label {
            margin-right: 0.5rem;
        }
        .spectrogram-controls input[type="range"] {
            vertical-align: middle;
        }
    </style>
{% endblock %}

{% block content %}
    <header class="w-full max-w-5xl mx-auto my-8">
        <div class="text-center pt-8">
            <img
              src="https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/static/articulation/mystical_mirror.png"
              alt="Mystical Mirror Visual"
              class="w-48 mx-auto mb-4 [filter:drop-shadow(0_0_15px_rgba(255,255,255,0.3))]"
              onerror="this.onerror=null; this.src='https://placehold.co/192x108/0c0a18/a78bfa?text=Mystical-Mirror';"
            />
            <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-500">
              Mystical Mirror
            </h1>
            <p class="text-md md:text-lg text-slate-400 italic max-w-3xl mx-auto mt-2">
                Visualize your speech and match the target phoneme.
            </p>
        </div>
    </header>
    <main class="w-full max-w-6xl mx-auto flex-grow">
        
        <div id="selection-container" class="mb-12 p-6 bg-slate-900/40 rounded-2xl border border-violet-900/80 text-center">
            <label for="phoneme-select" class="block text-xl font-bold text-violet-400 mb-4">Select a Target Phoneme</label>
            <select id="phoneme-select" class="bg-slate-800 border border-slate-700 text-slate-200 text-lg rounded-lg focus:ring-violet-500 focus:border-violet-500 p-2.5 w-full max-w-xs mx-auto">
                </select>
            <div class="text-center mt-6">
                <button id="begin-drill-btn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 text-lg">Begin Drill</button>
            </div>
        </div>

        <div id="drill-container" class="w-full grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            
            <div class="bg-slate-900/40 p-4 rounded-xl border border-violet-900/80">
                <h2 class="text-2xl font-bold text-violet-400 mb-4 text-center">Practice Video</h2>
                <div class="aspect-w-16 aspect-h-9">
                     <iframe id="phoneme-video" class="w-full h-auto aspect-video rounded-lg" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>

            <div class="space-y-8">
                <div class="bg-slate-900/40 p-4 rounded-xl border border-violet-900/80">
                    <h2 class="text-2xl font-bold text-violet-400 mb-4 text-center">Target</h2>
                    <img id="spectrogram-image" src="https://placehold.co/600x250/0c0a18/a78bfa?text=Select+a+phoneme" alt="Target Spectrogram" class="w-full rounded-lg mx-auto">
                </div>

                <div class="bg-slate-900/40 p-4 rounded-xl border border-violet-900/80">
                    <h2 class="text-2xl font-bold text-violet-400 mb-4 text-center">Live Feed</h2>
                    <div id="spectInstructions" class="text-center text-slate-400 p-4">
                        <p>Click "Begin Drill" to start the microphone.</p>
                    </div>
                    <div id="spectrogramGui" style="display:none;" class="flex flex-col items-center">
                        <canvas id="colorPlot"></canvas>
                        <div id="noAudioAPI" class="text-red-400 mt-2"></div>
                        <div class="spectrogram-controls mt-4 flex items-center space-x-4 text-slate-300">
                             <label for="pause">Pause:</label>
                             <input type="checkbox" id="pause" class="w-5 h-5 rounded text-violet-500 focus:ring-violet-600"/>
                             <label for="noiseFloor">Noise Floor:</label>
                             <input type="range" min="50" max="150" value="100" id="noiseFloor" onchange="noiseFloorChange();">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <!-- SCRIPT LIBRARIES -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script id="jans-audio-stuff-lib">
        /* Helper routines for using Web Audio.
        Borrowed heavily from Corban Brook's dsp.js
        */
        var context;
        function initAudio() {
          console.log("running initAudio()");
        
          if (typeof AudioContext !== "undefined") {
            context = new AudioContext();
          } else if (typeof webkitAudioContext !== "undefined") {
            context = new webkitAudioContext();
          } else {
            document.getElementById('noAudioAPI').innerHTML="<strong>This demo requires a browser which supports HTML5 and web audio, such as recent versions of Chrome, Firefox and Opera browsers.</strong>";
            throw new Error('AudioContext not supported by this web browser. :(');
          }
        }
    </script>
    <script>
            // --- Spectrogram Script provided by user ---
            var canv;
            var canvHeight = 325;
            var canvWidth = 600;
            var canvBorderWidth = 30;
            var aplot,
                previousData,
                analyser, nyquist,
                spectorgramAnimationTimer,
                spectrogramInterval;
            var microphone;
            var canvasCtx;
            var colormap;
            const fftSize = 2048; // at a sample rate of 48kHz this will give us a frequency resultion of 23.4 Hz

            function processSoundTick() {
                if (!document.getElementById("pause").checked)
                    if (analyser !== undefined) {
                        if (context.state !== 'running') {
                            context.resume();
                            console.log('Resuming audio context');
                        }
                        var freqByteData = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(freqByteData);
                        updateCanvas(canv, freqByteData);
                    }
            }

            function spectDataToImageData(newData, ctx) {
                var imgData = ctx.createImageData(1, canvHeight - canvBorderWidth - 1); // Use createImageData for compatibility
                var L = imgData.data.length;
                var offset = L - 4;
                for (var i = 0; i < L; i += 4) {
                    var dataIndex = Math.min(255, Math.floor(i / 4)); // Ensure index is within bounds
                    imgData.data[offset - i + 0] = colormap.red[newData[dataIndex]];
                    imgData.data[offset - i + 1] = colormap.green[newData[dataIndex]];
                    imgData.data[offset - i + 2] = colormap.blue[newData[dataIndex]];
                    imgData.data[offset - i + 3] = 255;
                }
                return imgData;
            }

            function updateCanvas(ctx, newData) {
                if (previousData === undefined) previousData = newData;
                var imgData = ctx.getImageData(canvBorderWidth + 1, 0, canvWidth - canvBorderWidth - 1, canvHeight - canvBorderWidth - 1);
                ctx.putImageData(imgData, canvBorderWidth, 0);
                
                // Interpolation logic seems complex, simplifying to just put new data for now.
                // This can be expanded later if the interpolation effect is critical.
                ctx.putImageData(spectDataToImageData(newData, ctx), canvWidth - 1, 0);

                previousData = newData;
            }

            function streamGenerationError() {
                alert('Stream generation failed. Please ensure you have a microphone and have granted permission.');
            }

            function getUserMedia(dictionary, callback) {
                try {
                    navigator.getUserMedia =
                        navigator.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia;
                    navigator.getUserMedia(dictionary, callback, streamGenerationError);
                } catch (e) {
                    alert('getUserMedia threw exception :' + e + '. This probably means you are using an incompatible browser. Try Firefox or Chrome.');
                }
            }

            function gotStream(stream) {
                console.log('connecting to the microphone');
                microphone = context.createMediaStreamSource(stream);
                analyser = context.createAnalyser();
                analyser.fftSize = fftSize;
                analyser.smoothingTimeConstant = 0.4;
                noiseFloorChange(); // Call with initial value
                microphone.connect(analyser);
                
                console.log('making the plot visible');
                document.getElementById("spectInstructions").style.display = "none";
                document.getElementById("spectrogramGui").style.display = "flex";
                
                if (spectorgramAnimationTimer) clearInterval(spectorgramAnimationTimer);
                spectorgramAnimationTimer = setInterval(processSoundTick, spectrogramInterval);
            }

            function toggleLiveInput() {
                console.log('starting acquisition');
                getUserMedia({ audio: true }, gotStream);
            }

            function linspace(from, to, nsteps) {
                var result = new Uint8Array(nsteps); // Changed to Uint8Array for color values
                var astep = (to - from) / (nsteps - 1);
                for (var i = 0; i < nsteps; i++)
                    result[i] = Math.round(from + i * astep);
                return result;
            }

            function Ui8concat(first, second) {
                var firstLength = first.length;
                var result = new Uint8Array(firstLength + second.length);
                result.set(first);
                result.set(second, firstLength);
                return result;
            }

            function setupColorMap() {
                colormap = {};
                /* Using the provided 'plasma' map */
                colormap.red = new Uint8Array([12, 16, 19, 21, 24, 27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 52, 54, 56, 58, 59, 61, 63, 64, 66, 68, 69, 71, 73, 74, 76, 78, 79, 81, 82, 84, 86, 87, 89, 90, 92, 94, 95, 97, 98, 100, 101, 103, 104, 106, 108, 109, 111, 112, 114, 115, 117, 118, 120, 121, 123, 124, 126, 127, 129, 130, 132, 133, 134, 136, 137, 139, 140, 142, 143, 144, 146, 147, 149, 150, 151, 153, 154, 155, 157, 158, 159, 160, 162, 163, 164, 165, 167, 168, 169, 170, 172, 173, 174, 175, 176, 177, 178, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 209, 210, 211, 212, 213, 214, 215, 215, 216, 217, 218, 219, 220, 220, 221, 222, 223, 223, 224, 225, 226, 227, 227, 228, 229, 229, 230, 231, 232, 232, 233, 234, 234, 235, 236, 236, 237, 237, 238, 239, 239, 240, 240, 241, 242, 242, 243, 243, 244, 244, 245, 245, 246, 246, 246, 247, 247, 248, 248, 248, 249, 249, 250, 250, 250, 250, 251, 251, 251, 252, 252, 252, 252, 252, 252, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 253, 252, 252, 252, 252, 252, 251, 251, 251, 250, 250, 250, 249, 249, 248, 248, 247, 247, 246, 246, 245, 245, 244, 243, 243, 242, 242, 241, 240, 240, 239]);
                colormap.green = new Uint8Array([7, 7, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 3, 3, 4, 4, 5, 6, 7, 7, 8, 9, 10, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 23, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 50, 51, 52, 53, 54, 55, 56, 57, 59, 60, 61, 62, 63, 64, 65, 66, 68, 69, 70, 71, 72, 73, 74, 75, 77, 78, 79, 80, 81, 82, 83, 85, 86, 87, 88, 89, 90, 91, 93, 94, 95, 96, 97, 98, 100, 101, 102, 103, 104, 106, 107, 108, 109, 110, 112, 113, 114, 115, 116, 118, 119, 120, 121, 123, 124, 125, 126, 128, 129, 130, 132, 133, 134, 135, 137, 138, 139, 141, 142, 143, 145, 146, 147, 149, 150, 152, 153, 154, 156, 157, 159, 160, 162, 163, 164, 166, 167, 169, 170, 172, 173, 175, 176, 178, 179, 181, 182, 184, 185, 187, 188, 190, 192, 193, 195, 196, 198, 199, 201, 203, 204, 206, 208, 209, 211, 213, 214, 216, 217, 219, 221, 223, 224, 226, 228, 229, 231, 233, 234, 236, 238, 240, 241, 243, 245, 246, 248]);
                colormap.blue = new Uint8Array([134, 135, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 148, 149, 150, 151, 152, 152, 153, 154, 154, 155, 156, 156, 157, 158, 158, 159, 159, 160, 161, 161, 162, 162, 163, 163, 163, 164, 164, 165, 165, 165, 166, 166, 166, 167, 167, 167, 167, 167, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 168, 167, 167, 167, 167, 167, 166, 166, 166, 165, 165, 164, 164, 164, 163, 163, 162, 161, 161, 160, 160, 159, 158, 158, 157, 156, 155, 155, 154, 153, 152, 151, 151, 150, 149, 148, 147, 146, 145, 144, 143, 143, 142, 141, 140, 139, 138, 137, 136, 135, 134, 133, 132, 131, 130, 129, 128, 128, 127, 126, 125, 124, 123, 122, 121, 120, 119, 118, 117, 117, 116, 115, 114, 113, 112, 111, 110, 109, 109, 108, 107, 106, 105, 104, 103, 102, 102, 101, 100, 99, 98, 97, 96, 96, 95, 94, 93, 92, 91, 90, 90, 89, 88, 87, 86, 85, 84, 84, 83, 82, 81, 80, 79, 78, 77, 77, 76, 75, 74, 73, 72, 71, 71, 70, 69, 68, 67, 66, 65, 65, 64, 63, 62, 61, 60, 59, 58, 58, 57, 56, 55, 54, 53, 53, 52, 51, 50, 49, 49, 48, 47, 46, 45, 45, 44, 43, 43, 42, 41, 41, 40, 40, 39, 38, 38, 38, 37, 37, 37, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 37, 37, 37, 38, 38, 38, 38, 38, 38, 38, 38, 37, 35, 33]);
            }

            function noiseFloorChange() {
                if (!analyser) return;
                var newval = document.getElementById("noiseFloor").value;
                console.log('changing noise floor to ' + newval);
                analyser.minDecibels = -newval;
                analyser.maxDecibels = analyser.minDecibels + 50;
            }

            // --- Page Interaction Logic ---
            $(function() {
                // Data for phonemes
                 const phonemes = [
                    { symbol: '/p/', slug: 'p', videoId: 'Ct6j4-A4Q6Y' },
                    { symbol: '/b/', slug: 'b', videoId: '3eat-85h3gY' },
                    { symbol: '/m/', slug: 'm', videoId: 'V-ZTKRBuL9M' },
                    { symbol: '/w/', slug: 'w', videoId: 'h6aLp3o3x4o' },
                    { symbol: '/f/', slug: 'f', videoId: 'v-b1qC228E0' },
                    { symbol: '/v/', slug: 'v', videoId: 'g-PZ-QyA_dQ' },
                    { symbol: '/θ/', slug: 'theta', videoId: 'z-31b_X-l98' }, // th (voiceless)
                    { symbol: '/ð/', slug: 'eth', videoId: '5-927oY88jY' }, // th (voiced)
                    { symbol: '/t/', slug: 't', videoId: 'm47y8sZG-a4' },
                    { symbol: '/d/', slug: 'd', videoId: 'Wd34p-XoA3U' },
                    { symbol: '/s/', slug: 's', videoId: 'RWaoaed9MmM' },
                    { symbol: '/z/', slug: 'z', videoId: 'S-e5bUALKIY' },
                    { symbol: '/n/', slug: 'n', videoId: '4-f8v3s3B4w' },
                    { symbol: '/l/', slug: 'l', videoId: 'f0g07yB-V4w' },
                    { symbol: '/ʃ/', slug: 'esh', videoId: 'y-Wr26f3F3E' }, // sh
                    { symbol: '/ʒ/', slug: 'ezh', videoId: 'w59jxxWYrM8' }, // zh (measure)
                    { symbol: '/t͡ʃ/', slug: 'tch', videoId: 'w5k2_0wE-iE' },// ch
                    { symbol: '/d͡ʒ/', slug: 'dzh', videoId: 'Oq5S6A-DS_o' },// j
                    { symbol: '/ɹ/', slug: 'r', videoId: 'EprV-bId9pA' }, // r
                    { symbol: '/j/', slug: 'j', videoId: 'i_hAc2Hrh68' }, // y
                    { symbol: '/k/', slug: 'k', videoId: 'cI-QD-S_LpQ' },
                    { symbol: '/g/', slug: 'g', videoId: 'yK8R-f4wCLA' },
                    { symbol: '/ŋ/', slug: 'eng', videoId: 'J4VjJ3A9SgU' }, // ng
                    { symbol: '/h/', slug: 'h', videoId: '2F0h0jI2Vo0' },
                ];

                // Get DOM elements
                const phonemeSelect = $('#phoneme-select');
                const beginDrillBtn = $('#begin-drill-btn');
                const drillContainer = $('#drill-container');
                const phonemeVideo = $('#phoneme-video');
                const spectrogramImage = $('#spectrogram-image');
                
                let isMicInitialized = false;

                // Populate select dropdown
                phonemes.forEach(p => {
                    phonemeSelect.append(`<option value="${p.slug}">${p.symbol}</option>`);
                });
                
                // Setup Spectrogram Canvas (without starting mic)
                initAudio();
                spectrogramInterval = 40; // ms
                canv = document.getElementById("colorPlot").getContext("2d");
                var canvas = document.getElementById("colorPlot");
                canvas.width = canvWidth;
                canvas.height = canvHeight;
                setupColorMap();

                // Draw axis labels
                canv.fillStyle = "#94a3b8"; // slate-400
                canv.font = "15px Arial";
                canv.textAlign = "center";
                canv.fillText("0", canvBorderWidth, canvHeight - 12);
                var pixelsPerSecond = (1000 / spectrogramInterval);
                canv.fillText("1", canvBorderWidth + pixelsPerSecond, canvHeight - 12);
                canv.fillText("2", canvBorderWidth + pixelsPerSecond * 2, canvHeight - 12);
                canv.fillText("3", canvBorderWidth + pixelsPerSecond * 3, canvHeight - 12);
                canv.fillText("4", canvBorderWidth + pixelsPerSecond * 4, canvHeight - 12);
                canv.textAlign = "end";
                canv.fillText("seconds", canvWidth, canvHeight - 6);

                var pixelsPerKHz = (canvHeight - canvBorderWidth) / (context.sampleRate / 2000);
                for (let i = 0; i <= 8; i++) {
                    if(i > (context.sampleRate / 2000)) break; // Don't draw labels for frequencies we can't see
                    canv.fillText(i.toString(), canvBorderWidth - 4, canvHeight - canvBorderWidth - (i * pixelsPerKHz));
                }

                canv.save();
                canv.translate(canvBorderWidth - 20, (canvHeight - canvBorderWidth) / 2);
                canv.rotate(-Math.PI / 2);
                canv.textAlign = "center";
                canv.fillText("kHz", 0, 0);
                canv.restore();
                canv.strokeStyle = "#475569"; // slate-600
                canv.strokeRect(canvBorderWidth, 0, canvWidth - canvBorderWidth, canvHeight - canvBorderWidth);

                // Handle "Begin Drill" button click
                beginDrillBtn.on('click', function() {
                    const selectedSlug = phonemeSelect.val();
                    const phoneme = phonemes.find(p => p.slug === selectedSlug);

                    if (phoneme) {
                        // Update video and image
                        const videoUrl = `https://www.youtube.com/embed/${phoneme.videoId}`;
                        phonemeVideo.attr('src', videoUrl);

                        // Using a placeholder for the static spectrogram image
                        const imageUrl = `https://raw.githubusercontent.com/navasdo/navacite/refs/heads/main/templates/static/articulation/spectrograms/spectro.png`;
                        spectrogramImage.attr('src', imageUrl);

                        // Show the drill container
                        drillContainer.css('display', 'grid');

                        // Initialize microphone only once
                        if (!isMicInitialized) {
                            toggleLiveInput();
                            isMicInitialized = true;
                        }
                    }
                });
            });
    </script>
{% endblock %}
